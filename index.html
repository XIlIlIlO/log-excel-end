<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ ë¶„í•  ë° í†µí•© ë°±í…ŒìŠ¤íŠ¸ ë„êµ¬</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background-color: #f4f7f9;
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        h1 { color: #333; margin-bottom: 2rem; font-size: 1.8rem; }
        .form-group { text-align: left; margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="number"], input[type="file"] {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px;
            box-sizing: border-box; font-size: 1rem;
        }
        .btn-process {
            width: 100%; padding: 15px; background-color: #007bff; color: white;
            border: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; transition: background 0.3s; margin-top: 10px;
        }
        .btn-process:hover { background-color: #0056b3; }
        .status-area {
            margin-top: 20px; padding: 15px; border-radius: 10px;
            background-color: #f8f9fa; min-height: 50px; font-size: 0.95rem;
            white-space: pre-line; text-align: left; color: #444;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš€ ë¡œê·¸ ë¶„í•  ë° ì§‘ë‹¨ í†µí•© ë„êµ¬</h1>
    
    <div class="form-group">
        <label for="lossValue">ğŸ’° ì˜ˆìƒ ì†ì ˆ ê¸ˆì•¡ (User Loss Value)</label>
        <input type="number" id="lossValue" value="834">
    </div>

    <div class="form-group">
        <label for="logFiles">ğŸ“‚ .log íŒŒì¼ ì„ íƒ (pc1, pc2 ë“± ë‹¤ì¤‘ ì„ íƒ)</label>
        <input type="file" id="logFiles" accept=".log,.txt" multiple>
    </div>

    <button class="btn-process" onclick="startProcessing()">ë¶„í•  ë° í†µí•© ì‹¤í–‰</button>

    <div id="status" class="status-area">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ì‹¤í–‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
</div>

<script>
    const DELIMITER = "ëª¨ë“  ê·¸ë£¹ì— ëŒ€í•œ ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ";

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function cleanNumber(v) {
        if (!v) return 0;
        const num = parseFloat(String(v).replace(/[^\d.-]/g, ''));
        return isNaN(num) ? 0 : num;
    }

    function calculateWinRate(win, loss) {
        const total = win + loss;
        return total === 0 ? "0.000%" : ((win / total) * 100).toFixed(3) + "%";
    }

    function formatDate(val) {
        if (!val) return "";
        const match = String(val).trim().match(/^(\d{4}-\d{2}-\d{2}\s\d{2})/);
        return match ? match[1] : val;
    }

    // ì—‘ì…€ ìŠ¤íƒ€ì¼ ì ìš© í•¨ìˆ˜
    function applyStyle(ws, header1, header2) {
        ws['!cols'] = [{wch: 22}, {wch: 18}, {wch: 18}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 12}];
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cell = ws[XLSX.utils.encode_cell({r: R, c: C})];
                if (!cell) continue;
                cell.s = {
                    font: { name: "ë§‘ì€ ê³ ë”•", sz: 10 },
                    alignment: { vertical: "center", horizontal: (C === 0 ? "left" : "center") },
                    border: { top: {style:"thin"}, bottom: {style:"thin"}, left: {style:"thin"}, right: {style:"thin"} }
                };
                if (R === header1 || R === header2) {
                    cell.s.fill = { fgColor: { rgb: "F2F2F2" } };
                    cell.s.font.bold = true;
                    cell.s.alignment.horizontal = "center";
                }
            }
        }
    }

    // ë¡œê·¸ ì„¸ê·¸ë¨¼íŠ¸ íŒŒì‹± í•¨ìˆ˜
    function parseLogSegment(content, userLoss) {
        const lines = content.split(/\r?\n/);
        let groups = [];
        let totalRecord = null;
        let currentRecord = {};
        let currentType = null;
        let batchGroups = [];

        lines.forEach(line => {
            line = line.trim();
            const isTotal = line.includes("[Backtest Report]") && line.includes("ë°±í…ŒìŠ¤íŒ… í•©ì‚° ê²°ê³¼");
            const isGroup = line.includes("[Backtest Report]") && !line.includes("ë°±í…ŒìŠ¤íŒ… í•©ì‚° ê²°ê³¼");

            if (isTotal || isGroup) {
                if (Object.keys(currentRecord).length > 0) {
                    // ê³„ì‚° (ê¸°ëŠ¥ 1 ë¡œì§)
                    const win = currentRecord.win || 0;
                    const loss = currentRecord.loss || 0;
                    const profit = currentRecord.profit || 0;
                    const fee = currentRecord.fee || 0;
                    const calcLoss = userLoss * loss;
                    const realized = profit - calcLoss - fee;
                    const unrealized = (currentRecord.equity || 0) - (currentRecord.balance || 0);
                    
                    const record = {
                        name: currentRecord.name,
                        start: currentRecord.start,
                        end: currentRecord.end,
                        profit: profit,
                        lossAmount: calcLoss,
                        fee: fee,
                        realized: realized,
                        unrealized: unrealized,
                        net: realized + unrealized,
                        winCount: win,
                        lossCount: loss,
                        winRate: calculateWinRate(win, loss),
                        totalGroups: currentRecord.totalGroups || 0
                    };

                    if (currentType === 'group') batchGroups.push(record);
                    else if (currentType === 'total') {
                        totalRecord = record;
                        groups = [...batchGroups]; // ë§ˆì§€ë§‰ í•©ì‚° ê²°ê³¼ ì§ì „ì˜ ê·¸ë£¹ë“¤ ì €ì¥
                    }
                }
                currentRecord = {};
                currentType = isTotal ? 'total' : 'group';
                return;
            }

            if (line.includes("- Group Name")) currentRecord.name = line.split(":")[1].trim();
            else if (line.includes("- ì‹œì‘ì¼")) currentRecord.start = formatDate(line.split(":")[1]);
            else if (line.includes("- ì¢…ë£Œì¼")) currentRecord.end = formatDate(line.split(":")[1]);
            else if (line.includes("- Last Balance")) currentRecord.balance = cleanNumber(line.split(":")[1]);
            else if (line.includes("- Last Equity")) currentRecord.equity = cleanNumber(line.split(":")[1]);
            else if (line.includes("- ì´ ìµì ˆ íšŒìˆ˜")) currentRecord.win = cleanNumber(line.split(":")[1]);
            else if (line.includes("- ì´ ì†ì ˆ íšŒìˆ˜")) currentRecord.loss = cleanNumber(line.split(":")[1]);
            else if (line.includes("- ìµì ˆ ê¸ˆì•¡") || line.includes("- ìµì ˆê¸ˆì•¡")) currentRecord.profit = cleanNumber(line.split(":")[1]);
            else if (line.includes("- Total ìˆ˜ìˆ˜ë£Œ")) currentRecord.fee = cleanNumber(line.split(":")[1]);
            else if (line.includes("- ì „ì²´ ê·¸ë£¹ ìˆ˜")) currentRecord.totalGroups = cleanNumber(line.split(":")[1]);
        });

        return { groups, total: totalRecord };
    }

    async function startProcessing() {
        const fileInput = document.getElementById('logFiles');
        const lossValue = parseFloat(document.getElementById('lossValue').value) || 0;
        const status = document.getElementById('status');

        if (fileInput.files.length === 0) {
            status.innerHTML = "<span class='error'>íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</span>";
            return;
        }

        status.innerHTML = "<span class='info'>íŒŒì¼ ì½ëŠ” ì¤‘...</span>";
        
        const fileData = [];
        for (let file of fileInput.files) {
            const text = await file.text();
            // 1. "ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ" ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ”
            const segments = text.split(DELIMITER).filter(s => s.trim().length > 100);
            fileData.push(segments);
        }

        const maxSegments = Math.max(...fileData.map(f => f.length));
        status.innerHTML = `<span class='info'>ì´ ${fileInput.files.length}ê°œ íŒŒì¼ ë¶„ì„ ì™„ë£Œ. ì„¸ì…˜ ìˆ˜: ${maxSegments}</span>\n`;

        // ì§‘ë‹¨ë³„ í†µí•© ì²˜ë¦¬ (A, B, C...)
        for (let s = 0; s < maxSegments; s++) {
            let combinedGroups = [];
            let combinedStats = {
                totalGroups: 0, profit: 0, lossAmount: 0, fee: 0,
                realized: 0, unrealized: 0, net: 0, winCount: 0, lossCount: 0,
                start: "", end: ""
            };

            for (let f = 0; f < fileData.length; f++) {
                if (fileData[f][s]) {
                    const parsed = parseLogSegment(fileData[f][s], lossValue);
                    if (parsed.total) {
                        combinedGroups.push(...parsed.groups);
                        combinedStats.totalGroups += parsed.total.totalGroups;
                        combinedStats.profit += parsed.total.profit;
                        combinedStats.lossAmount += parsed.total.lossAmount;
                        combinedStats.fee += parsed.total.fee;
                        combinedStats.realized += parsed.total.realized;
                        combinedStats.unrealized += parsed.total.unrealized;
                        combinedStats.net += parsed.total.net;
                        combinedStats.winCount += parsed.total.winCount;
                        combinedStats.lossCount += parsed.total.lossCount;
                        if (!combinedStats.start) combinedStats.start = parsed.total.start;
                        combinedStats.end = parsed.total.end;
                    }
                }
            }

            if (combinedGroups.length > 0) {
                // ê¸°ëŠ¥ 2: í†µí•© ë° ì •ë ¬
                combinedGroups.sort((a, b) => a.name.localeCompare(b.name));
                
                const groupChar = String.fromCharCode(65 + s); // A, B, C...
                status.innerHTML += `ì§‘ë‹¨ ${groupChar} ìƒì„± ì¤‘...\n`;

                const totalHeaders = ["ì „ì²´ ê·¸ë£¹ ìˆ˜", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ì´ìµì ˆê¸ˆì•¡", "ì´ì†ì ˆê¸ˆì•¡", "ì´ìˆ˜ìˆ˜ë£Œ", "ì´í™•ì •ì†ìµê¸ˆ", "ì´ë¯¸ì‹¤í˜„ì†ìµ", "ì´ìˆœì´ìµ", "ì´ìµì ˆíšŸìˆ˜", "ì´ì†ì ˆíšŸìˆ˜", "ì „ì²´ìŠ¹ë¥ "];
                const totalRow = [
                    combinedStats.totalGroups, combinedStats.start, combinedStats.end,
                    combinedStats.profit, combinedStats.lossAmount, combinedStats.fee,
                    combinedStats.realized, combinedStats.unrealized, combinedStats.net,
                    combinedStats.winCount, combinedStats.lossCount, calculateWinRate(combinedStats.winCount, combinedStats.lossCount)
                ];

                const groupHeaders = ["Group Name", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ìµì ˆê¸ˆì•¡", "ì†ì ˆê¸ˆì•¡", "ìˆ˜ìˆ˜ë£Œ", "í™•ì •ì†ìµê¸ˆ", "ë¯¸ì‹¤í˜„ì†ìµ", "ìˆœì´ìµ", "ìµì ˆíšŸìˆ˜", "ì†ì ˆíšŸìˆ˜", "ìŠ¹ë¥ "];
                const wsData = [totalHeaders, totalRow, [], [], groupHeaders];
                
                combinedGroups.forEach(g => {
                    wsData.push([g.name, g.start, g.end, g.profit, g.lossAmount, g.fee, g.realized, g.unrealized, g.net, g.winCount, g.lossCount, g.winRate]);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                applyStyle(ws, 0, 4);

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Integrated_Result");
                XLSX.writeFile(wb, `ì§‘ë‹¨_${groupChar}_í†µí•©ê²°ê³¼.xlsx`);
            }
        }
        status.innerHTML += "<span class='success'>âœ… ëª¨ë“  ì§‘ë‹¨ í†µí•© ì™„ë£Œ ë° ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</span>";
    }
</script>

</body>
</html>
