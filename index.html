<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ìš©ëŸ‰ ë¡œê·¸ í†µí•© ì‹œìŠ¤í…œ (Pro)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f0f2f5; padding: 40px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
        h1 { text-align: center; color: #333; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="number"], input[type="file"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .btn-main:hover { background: #0056b3; }
        
        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
        .progress-container { margin-top: 20px; display: none; }
        .progress-bar { width: 100%; background: #eee; border-radius: 10px; overflow: hidden; height: 20px; }
        .progress-fill { width: 0%; height: 100%; background: #28a745; transition: width 0.1s; }
        
        .status-log { margin-top: 15px; font-size: 0.9rem; color: #666; max-height: 150px; overflow-y: auto; background: #fafafa; padding: 10px; border-radius: 5px; border: 1px solid #eee; }
        
        /* ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        #resultArea { margin-top: 30px; display: none; text-align: left; }
        .result-item { display: flex; justify-content: space-between; align-items: center; background: #e9ecef; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .btn-download { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-download:hover { background: #218838; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“Š ëŒ€ìš©ëŸ‰ ë¡œê·¸ ì§‘ë‹¨ í†µí•© ë„êµ¬</h1>
    
    <div class="form-group">
        <label>ğŸ’° ì˜ˆìƒ ì†ì ˆ ê¸ˆì•¡ (User Loss Value)</label>
        <input type="number" id="lossValue" value="834">
    </div>

    <div class="form-group">
        <label>ğŸ“‚ .log íŒŒì¼ë“¤ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥, 4GB+ ì§€ì›)</label>
        <input type="file" id="logFiles" accept=".log,.txt" multiple>
    </div>

    <button class="btn-main" id="startBtn" onclick="processAllFiles()">ë°ì´í„° ë¶„ì„ ë° ì§‘ë‹¨ ë¶„ë¥˜ ì‹œì‘</button>

    <div class="progress-container" id="progCont">
        <div id="progLabel">íŒŒì¼ ë¶„ì„ ì¤‘... (0%)</div>
        <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>
    </div>

    <div class="status-log" id="status">íŒŒì¼ì„ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.</div>

    <div id="resultArea">
        <h3>âœ… ìƒì„±ëœ í†µí•© ê²°ê³¼ (ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”)</h3>
        <div id="downloadList"></div>
    </div>
</div>

<script>
    const DELIMITER = "ëª¨ë“  ê·¸ë£¹ì— ëŒ€í•œ ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ";
    const CHUNK_SIZE = 50 * 1024 * 1024; // 50MBì”© ì½ì–´ ë©”ëª¨ë¦¬ ê³¼ë¶€í•˜ ë°©ì§€
    
    let sessionDataMap = {}; // ì§‘ë‹¨ë³„(0, 1, 2...) í†µí•© ë°ì´í„°ë¥¼ ì €ì¥í•  ê°ì²´

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    const cleanNum = v => {
        if (!v) return 0;
        const n = parseFloat(String(v).replace(/[^\d.-]/g, ''));
        return isNaN(n) ? 0 : n;
    };
    const formatDt = v => v ? (String(v).trim().match(/^(\d{4}-\d{2}-\d{2}\s\d{2})/) || [v])[0] : "";
    const calcWinRate = (w, l) => (w + l === 0) ? "0.000%" : ((w / (w + l)) * 100).toFixed(3) + "%";

    function log(msg, type = '') {
        const status = document.getElementById('status');
        status.innerHTML += `<div class="${type}">${msg}</div>`;
        status.scrollTop = status.scrollHeight;
    }

    // íŒŒì¼ í•˜ë‚˜ë¥¼ ì²­í¬ ë‹¨ìœ„ë¡œ ì½ì–´ ì„¸ì…˜(ì§‘ë‹¨)ë³„ë¡œ íŒŒì‹±
    async function readFileByChunks(file, userLoss, fileIndex) {
        let offset = 0;
        let leftover = "";
        let sessionIndex = 0;

        while (offset < file.size) {
            const chunk = file.slice(offset, offset + CHUNK_SIZE);
            const text = await chunk.text();
            const fullText = leftover + text;
            
            // êµ¬ë¶„ìë¡œ ì„¸ì…˜ ë¶„ë¦¬
            const parts = fullText.split(DELIMITER);
            leftover = parts.pop(); // ë§ˆì§€ë§‰ ë¶€ë¶„ì€ ë‹¤ìŒ ì²­í¬ì™€ í•©ì¹¨

            for (let part of parts) {
                if (part.trim().length > 50) {
                    processSegment(part, sessionIndex, userLoss);
                    sessionIndex++;
                }
            }

            offset += CHUNK_SIZE;
            updateProgress(offset, file.size, file.name);
        }
        
        // ë§ˆì§€ë§‰ ë‚¨ì€ ì¡°ê° ì²˜ë¦¬
        if (leftover.trim().length > 50) {
            processSegment(leftover, sessionIndex, userLoss);
        }
    }

    // ê°œë³„ ì„¸ê·¸ë¨¼íŠ¸ íŒŒì‹± ë° sessionDataMapì— ëˆ„ì  ì €ì¥
    function processSegment(content, sIdx, userLoss) {
        if (!sessionDataMap[sIdx]) {
            sessionDataMap[sIdx] = { groups: [], totalStats: { tg: 0, p: 0, l: 0, f: 0, r: 0, u: 0, n: 0, wc: 0, lc: 0, start: "", end: "" } };
        }

        const lines = content.split(/\r?\n/);
        let cur = {};
        let type = null;
        let batch = [];

        lines.forEach(line => {
            line = line.trim();
            if (line.includes("[Backtest Report]")) {
                if (Object.keys(cur).length > 0) {
                    const rec = finalizeRecord(cur, userLoss);
                    if (type === 'group') batch.push(rec);
                    else if (type === 'total') {
                        sessionDataMap[sIdx].groups.push(...batch);
                        accumulateTotal(sessionDataMap[sIdx].totalStats, rec);
                    }
                }
                cur = {};
                type = line.includes("ë°±í…ŒìŠ¤íŒ… í•©ì‚° ê²°ê³¼") ? 'total' : 'group';
                return;
            }
            if (line.includes("- Group Name")) cur.name = line.split(":")[1].trim();
            else if (line.includes("- ì‹œì‘ì¼")) cur.start = formatDt(line.split(":")[1]);
            else if (line.includes("- ì¢…ë£Œì¼")) cur.end = formatDt(line.split(":")[1]);
            else if (line.includes("- Last Balance")) cur.bal = cleanNum(line.split(":")[1]);
            else if (line.includes("- Last Equity")) cur.eq = cleanNum(line.split(":")[1]);
            else if (line.includes("- ì´ ìµì ˆ íšŒìˆ˜")) cur.wc = cleanNum(line.split(":")[1]);
            else if (line.includes("- ì´ ì†ì ˆ íšŒìˆ˜")) cur.lc = cleanNum(line.split(":")[1]);
            else if (line.includes("- ìµì ˆ ê¸ˆì•¡")) cur.p = cleanNum(line.split(":")[1]);
            else if (line.includes("- Total ìˆ˜ìˆ˜ë£Œ")) cur.f = cleanNum(line.split(":")[1]);
            else if (line.includes("- ì „ì²´ ê·¸ë£¹ ìˆ˜")) cur.tg = cleanNum(line.split(":")[1]);
        });
    }

    function finalizeRecord(c, lossVal) {
        const calcL = lossVal * (c.lc || 0);
        const realP = (c.p || 0) - calcL - (c.f || 0);
        const unrP = (c.eq || 0) - (c.bal || 0);
        return {
            name: c.name || "Total", start: c.start, end: c.end,
            p: c.p || 0, l: calcL, f: c.f || 0, r: realP, u: unrP, n: realP + unrP,
            wc: c.wc || 0, lc: c.lc || 0, wr: calcWinRate(c.wc||0, c.lc||0), tg: c.tg || 0
        };
    }

    function accumulateTotal(target, src) {
        target.tg += src.tg; target.p += src.p; target.l += src.l; target.f += src.f;
        target.r += src.r; target.u += src.u; target.n += src.n; target.wc += src.wc; target.lc += src.lc;
        if (!target.start) target.start = src.start; target.end = src.end;
    }

    async function processAllFiles() {
        const files = document.getElementById('logFiles').files;
        const lossVal = parseFloat(document.getElementById('lossValue').value) || 0;
        if (files.length === 0) return alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");

        document.getElementById('progCont').style.display = 'block';
        document.getElementById('downloadList').innerHTML = "";
        sessionDataMap = {};
        log("ë¶„ì„ ì‹œì‘...", "info");

        for (let i = 0; i < files.length; i++) {
            log(`${files[i].name} ì²˜ë¦¬ ì¤‘...`);
            await readFileByChunks(files[i], lossVal, i);
        }

        log("ë¶„ì„ ì™„ë£Œ! ì§‘ë‹¨ë³„ í†µí•© ë°ì´í„°ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.", "success");
        createDownloadButtons();
    }

    function createDownloadButtons() {
        const list = document.getElementById('downloadList');
        document.getElementById('resultArea').style.display = 'block';
        
        Object.keys(sessionDataMap).forEach(idx => {
            const char = String.fromCharCode(65 + parseInt(idx));
            const item = document.createElement('div');
            item.className = 'result-item';
            item.innerHTML = `
                <span><strong>ì§‘ë‹¨ ${char}</strong> (ë°ì´í„° ${sessionDataMap[idx].groups.length}ê±´)</span>
                <button class="btn-download" onclick="downloadExcel('${idx}')">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            `;
            list.appendChild(item);
        });
    }

    function downloadExcel(idx) {
        const data = sessionDataMap[idx];
        const char = String.fromCharCode(65 + parseInt(idx));
        
        const totalHeaders = ["ì „ì²´ ê·¸ë£¹ ìˆ˜", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ì´ìµì ˆê¸ˆì•¡", "ì´ì†ì ˆê¸ˆì•¡", "ì´ìˆ˜ìˆ˜ë£Œ", "ì´í™•ì •ì†ìµê¸ˆ", "ì´ë¯¸ì‹¤í˜„ì†ìµ", "ì´ìˆœì´ìµ", "ì´ìµì ˆíšŸìˆ˜", "ì´ì†ì ˆíšŸìˆ˜", "ì „ì²´ìŠ¹ë¥ "];
        const totalRow = [
            data.totalStats.tg, data.totalStats.start, data.totalStats.end,
            data.totalStats.p, data.totalStats.l, data.totalStats.f,
            data.totalStats.r, data.totalStats.u, data.totalStats.n,
            data.totalStats.wc, data.totalStats.lc, calcWinRate(data.totalStats.wc, data.totalStats.lc)
        ];

        const groupHeaders = ["Group Name", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ìµì ˆê¸ˆì•¡", "ì†ì ˆê¸ˆì•¡", "ìˆ˜ìˆ˜ë£Œ", "í™•ì •ì†ìµê¸ˆ", "ë¯¸ì‹¤í˜„ì†ìµ", "ìˆœì´ìµ", "ìµì ˆíšŸìˆ˜", "ì†ì ˆíšŸìˆ˜", "ìŠ¹ë¥ "];
        const wsData = [totalHeaders, totalRow, [], [], groupHeaders];
        
        data.groups.sort((a,b) => a.name.localeCompare(b.name)).forEach(g => {
            wsData.push([g.name, g.start, g.end, g.p, g.l, g.f, g.r, g.u, g.n, g.wc, g.lc, g.wr]);
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        applyExcelStyle(ws);

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, `Group_${char}_Integrated`);
        XLSX.writeFile(wb, `ì§‘ë‹¨_${char}_í†µí•©ê²°ê³¼.xlsx`);
    }

    function applyExcelStyle(ws) {
        ws['!cols'] = [{wch:22}, {wch:18}, {wch:18}, {wch:15}, {wch:15}, {wch:15}, {wch:15}, {wch:15}, {wch:15}, {wch:12}, {wch:12}, {wch:12}];
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const addr = XLSX.utils.encode_cell({r: R, c: C});
                if (!ws[addr]) continue;
                ws[addr].s = {
                    font: { name: "ë§‘ì€ ê³ ë”•", sz: 10 },
                    alignment: { vertical: "center", horizontal: C === 0 ? "left" : "center" },
                    border: { top: {style:"thin"}, bottom: {style:"thin"}, left: {style:"thin"}, right: {style:"thin"} }
                };
                if (R === 0 || R === 4) {
                    ws[addr].s.fill = { fgColor: { rgb: "F2F2F2" } };
                    ws[addr].s.font.bold = true;
                }
            }
        }
    }

    function updateProgress(offset, total, name) {
        const per = Math.min(100, Math.round((offset / total) * 100));
        document.getElementById('progFill').style.width = per + '%';
        document.getElementById('progLabel').innerText = `${name} ë¶„ì„ ì¤‘... (${per}%)`;
    }
</script>

</body>
</html>
